!function(){"use strict";var t=tinymce.util.Tools.resolve("tinymce.PluginManager");function e(){var e=this;this.target=null,this.editor=null,this.created=!1,this.dialogVisble=!1,this.handlers={},window.addEventListener("message",function(t){if(t.data&&t.data.eventName&&e.target)switch(document.querySelector(".j-cherry-mindmap-dialog .j-dialog-loading").style.display="none",t.data.eventName){case"GET_MINDMAP_DATA:SUCCESS":e.onSure(e.encodeJSON(t.data.value.jsonData),t.data.value.base64Data,t.data.value.imageInfo)}},!1)}var i=new(e.prototype.init=function(t){this.editor=t,this.mindmapUrl=t.getParam("cherry_mindmap_url","")},e.prototype.onSure=function(t,r,n){var o=this;void 0===n&&(n={});var d=this,s=this.target;this.beforeInsertJSON(t,function(e,i){void 0===i&&(i="");var t=o.editor.getParam("images_upload_handler",null);function a(){document.querySelector(".j-cherry-mindmap-dialog").style.display="none";var t=d.getParam("mindmap_save_failed",null);"function"==typeof t&&t(d.target),d.target=null,d.editor.fire("closeCustomDialog")}t?t({base64:function(){return r}},function(t){s.setAttribute("src",t),s.setAttribute("data-mce-src",t),s.setAttribute("data-mindmap-json",e),s.setAttribute("data-mindmap-oldjson",""),s.setAttribute("data-mindmap-oldsrc",""),s.setAttribute("data-mindmap-token",i),s.setAttribute("data-start-key",""),n.width&&s.setAttribute("width",""+n.width),document.querySelector(".j-cherry-mindmap-dialog").style.display="none",d.target=null,d.editor.fire("closeCustomDialog")},a):a()})},e.prototype.openMindmapDialog=function(t){t&&this.setDialogVisible(t,!0,t.getAttribute("data-mindmap-json"),t.getAttribute("data-mindmap-token"))},e.prototype.setDialogVisible=function(t,e,i,a){var r=this;void 0===i&&(i=""),void 0===a&&(a="");var n=!1;this.target&&(n=!!this.target.getAttribute("data-start-key"),!e&&n&&this.editor.dom.remove(this.target)),this.dialogVisble=e,this.created&&this.resetDialogSize(),e?(this.target=t,this.createIframe(function(){i&&t?r.beforeParseJSON(i,a,function(t){r.updateMindmap(t)}):r.updateMindmap(i)}),document.querySelector(".j-cherry-mindmap-dialog").style.display="block",document.querySelector(".j-cherry-mindmap-dialog .j-dialog-loading").style.display="block"):(document.querySelector(".j-cherry-mindmap-dialog").style.display="none",!n&&this.target.getAttribute("data-mindmap-oldjson")&&(this.target.setAttribute("data-mindmap-json",this.target.getAttribute("data-mindmap-oldjson")),this.target.setAttribute("src",this.target.getAttribute("data-mindmap-oldsrc")),this.target.setAttribute("data-mce-src",this.target.getAttribute("data-mindmap-oldsrc")),this.target.setAttribute("data-mindmap-oldjson",""),this.target.setAttribute("data-mindmap-oldsrc","")),this.target=t)},e.prototype.insertEmptyImg=function(){var t=this.encodeJSON(this.generateRandomKey()).replace(/=/g,"");this.editor.insertContent(this.createEmptyMindmaphImg(t));var e=this.editor.$('img[data-start-key="'+t+'"]');this.openMindmapDialog(e[0])},e.prototype.createEmptyMindmaphImg=function(t){var e=this.editor.getParam("mindmap_empty_img"),i=this.editor.getParam("mindmap_empty_json");return'<img src="'+e+'" data-start-key="'+t+'" alt="cherry-mindmap" title="\u70b9\u51fb\u56fe\u7247\uff0c\u8fdb\u5165\u601d\u7ef4\u5bfc\u56fe\u7f16\u8f91" data-control="cherry-mindmap" data-mindmap-json="'+i+'" data-mindmap-oldjson="'+i+'">'},e.prototype.createIframe=function(t){if(this.created&&document.querySelector(".j-cherry-mindmap-dialog"))return t(),void document.querySelector("#cherry-mindmap-dialog-iframe").focus();this.created=!0;var e=document.createElement("div");e.setAttribute("class","cherry-mindmap-dialog j-cherry-mindmap-dialog cherry-mindmap-dialog--normal"),e.style="display:none;",e.innerHTML='\n    <div class="cherry-mindmap-dialog__mask">\n    <div class="cherry-mindmap-dialog__content">\n        <div class="cherry-mindmap-dialog__head clearfix">\n            <span class="cherry-mindmap-dialog__head-title">\u63d2\u5165\u601d\u7ef4\u5bfc\u56fe</span>\n            <span class="cherry-mindmap-dialog__head-close ico-dialog-close j-close-dialog"></span>\n            <span class="cherry-mindmap-dialog__head-fullscreen font-editor font-editor-fullscreen j-set-dialog-size"></span>\n        </div>\n        <div class="cherry-mindmap-dialog__body">\n            <div class="cherry-mindmap-dialog__body--loading j-dialog-loading" style="display: block;">\n               <div class="cherry-mindmap-dialog__body--loading_icon strip-loading2"></div>\n            </div>\n            <iframe style="visibility: visible;" allowtransparency="true" id="cherry-mindmap-dialog-iframe" src="CHERRY_MINDMAP_URL" width="100%" frameborder="0" height="100%" loaded="true"></iframe>\n        </div>\n        <div class="cherry-mindmap-dialog__foot">\n        <div class="cherry-mindmap-dialog__foot-btns">\n            <span class="foot-btn foot-btn__ensure j-foot-btn__ensure">\u786e\u5b9a</span>\n            <span class="foot-btn foot-btn__cancel j-close-dialog">\u53d6\u6d88</span>\n        </div>\n        </div>\n    </div>\n    </div>\n'.replace("CHERRY_MINDMAP_URL",this.mindmapUrl),document.body.appendChild(e),this.bindEvent(),setTimeout(function(){t(),e.querySelector("#cherry-mindmap-dialog-iframe").focus()},3e3)},e.prototype.updateMindmap=function(t){this.dialogVisble&&(document.getElementById("cherry-mindmap-dialog-iframe").contentWindow.postMessage({eventName:"INIT_MINDMAP",value:this.decodeJSON(t)},"*"),this.target.getAttribute("data-mindmap-oldjson")||(this.target.setAttribute("data-mindmap-oldjson",this.target.getAttribute("data-mindmap-json")),this.target.setAttribute("data-mindmap-oldsrc",this.target.getAttribute("src")),this.target.setAttribute("src",this.editor.getParam("mindmap_empty_img")),this.target.setAttribute("data-mce-src",this.editor.getParam("mindmap_empty_img"))))},e.prototype.decodeJSON=function(t){return t&&0===t.trim().indexOf("id:")?t:t?decodeURIComponent(escape(window.atob(t))):null},e.prototype.encodeJSON=function(t){return t&&0===t.trim().indexOf("id:")?t:window.btoa(unescape(encodeURIComponent(t)))},e.prototype.bindEvent=function(){var e=this;document.querySelector(".j-cherry-mindmap-dialog")&&(document.querySelector(".j-cherry-mindmap-dialog .j-foot-btn__ensure").addEventListener("click",function(t){e.onInsertMindmap(t),e.editor.fire("showDialogTitle")}),document.querySelectorAll(".j-cherry-mindmap-dialog .j-close-dialog").forEach(function(t){t.addEventListener("click",function(t){e.editor.fire("showDialogTitle"),e.setDialogVisible(null,!1),e.editor.fire("closeCustomDialog")})}),document.querySelector(".j-cherry-mindmap-dialog .j-set-dialog-size").addEventListener("click",function(t){var e=document.querySelector(".j-cherry-mindmap-dialog"),i=t.target,a="",r=(r=i.getAttribute("class")).indexOf("font-editor-fullscreen-restore")<0?(a=e.getAttribute("class").replace(/cherry-mindmap-dialog--normal/g,"cherry-mindmap-dialog--fullscreen"),r.replace(/font-editor-fullscreen/g,"font-editor-fullscreen-restore")):(a=e.getAttribute("class").replace(/cherry-mindmap-dialog--fullscreen/g,"cherry-mindmap-dialog--normal"),r.replace(/font-editor-fullscreen-restore/g,"font-editor-fullscreen"));e.setAttribute("class",a),i.setAttribute("class",r)}))},e.prototype.resetDialogSize=function(){var t,e,i=document.querySelector(".j-cherry-mindmap-dialog"),a=i.getAttribute("class");-1<a.indexOf("cherry-mindmap-dialog--fullscreen")&&(a=a.replace(/cherry-mindmap-dialog--fullscreen/g,"cherry-mindmap-dialog--normal"),i.setAttribute("class",a),e=(e=(t=document.querySelector(".j-cherry-mindmap-dialog .j-set-dialog-size")).getAttribute("class")).replace(/font-editor-fullscreen-restore/g,"font-editor-fullscreen"),t.setAttribute("class",e))},e.prototype.onInsertMindmap=function(t){document.getElementById("cherry-mindmap-dialog-iframe").contentWindow.postMessage({eventName:"GET_MINDMAP_DATA",value:""},"*"),document.querySelector(".j-cherry-mindmap-dialog .j-dialog-loading").style.display="block"},e.prototype.base64ToFile=function(t,e){for(var i=window.atob(t.split(",")[1]),a=new ArrayBuffer(i.length),r=new Uint8Array(a),n=0;n<i.length;n++)r[n]=i.charCodeAt(n);var o=new Blob([a],{type:"image/png"});return o.lastModifiedDate=new Date,o.name=e,o},e.prototype.beforeInsertJSON=function(i,a){var t=this.editor.getParam("mindmap_before_insert_json","");t?t(i,function(t,e){t?a("id:"+t,e):a(i)}):a(i)},e.prototype.beforeParseJSON=function(e,t,i){var a,r="";e&&0===e.trim().indexOf("id:")?(r=e.trim().replace("id:",""),(a=this.editor.getParam("mindmap_before_parse_json",""))?a(r,t,function(t){i(t||e)}):i(e)):i(e)},e.prototype.generateRandomKey=function(){return Math.random().toString(36)},e.prototype.cacheMindmap=function(t){this.target.setAttribute("data-mindmap-json",this.encodeJSON(t)),this.editor.fire("keyup",this.editor)},e);t.add("cherry-mindmap",function(e){e.on("openCustomDialog",function(){e.getBody().setAttribute("contenteditable","false")}),e.on("closeCustomDialog",function(){e.getBody().setAttribute("contenteditable","true")}),e.ui.registry.addIcon("ch-mindmap",'<svg width="20px" height="20px" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n     viewBox="0 0 850.394 850.394" enable-background="new 0 0 850.394 850.394" xml:space="preserve">\n     <g transform="scale(0.9)">\n        <path fill="#2aa3ab"  d="M883 940h-765q-24 0 -41 -16.5t-17 -40.5v-765q0 -24 17 -41t41 -17h765q24 0 40.5 17t16.5 41v765q0 24 -16.5 40.5t-40.5 16.5zM882 118h-764v764h764v-764zM256 213q25 0 42 17t17 41q0 8 -2 15l84 71q29 -21 65 -21q18 0 35 5l49 -78q-9 -15 -9 -32q0 -24 17 -41\n        t41.5 -17t41.5 17t17 41t-17 41.5t-42 17.5l-6 -1l-50 79q23 23 29 54l124 4q8 -15 21.5 -23.5t30.5 -8.5q24 0 41 17t17 41t-17 41t-41 17q-17 0 -31.5 -9.5t-21.5 -24.5l-124 -4q-7 24 -23 42.5t-39 28.5l24 136q27 4 45 25t18 49q0 31 -22 53t-53 22t-53 -22t-22 -53\n        q0 -21 10.5 -38.5t27.5 -26.5l-24 -136q-29 -2 -54 -18l-65 62q3 8 3 18q0 24 -17.5 41t-41.5 17t-41 -17t-17 -41.5t17 -41.5t41 -17q11 0 22 4l65 -61q-14 -25 -14 -54q0 -26 11 -49l-84 -71q-12 5 -25 5q-24 0 -41 -17t-17 -41t17 -41t41 -17z"/>\n     </g>\n</svg>'),e.ui.registry.addButton("ch-mindmap",{icon:"ch-mindmap",tooltip:"CherryMindmap",onAction:function(){i.init(e),i.insertEmptyImg(),e.fire("openCustomDialog")},onSetup:function(){return e.on("click",function(t){"cherry-mindmap"===t.target.getAttribute("data-control")&&(i.init(e),i.openMindmapDialog(t.target),e.fire("openCustomDialog"))}),function(){}}})})}();