!function(){"use strict";var t,n,e=tinymce.util.Tools.resolve("tinymce.PluginManager"),l=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),u=tinymce.util.Tools.resolve("tinymce.util.I18n"),d=(t="chtoc_",n=0,function(){var e=(new Date).getTime().toString(32);return t+e+(n++).toString(32)}),c=function(e){return e.getParam("toc_class","toc")},s=function(e){for(var t=e.$("h1,h2,h3,h4,h5,h6"),n={},o=[],r=0;r<t.length;r++){var c,i,a=t[r];e.$.text(a).trim().length<=0||(i=(c=a.id)||0,c&&!n[c]||(i=d(),a.setAttribute("id",i)),n[i]=!0,o.push({id:i,level:parseInt(a.nodeName.replace(/^H/i,""),10),title:e.$.text(a),element:a}))}return o},i=function(e){var t='<p class="toc-title">'+l.DOM.encode(u.translate("Table of Contents"))+"</p>",n=s(e);if(!n.length)return m(e,t);for(var o=function(e){for(var t=9,n=0;n<e.length;n++)e[n].level<t&&(t=e[n].level);return 1<t?t:1}(n),r=0;r<n.length;r++){for(var c=n[r],i="",a=0;a<c.level-o;a++)i+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";t+='<li class="toc-li">'+i+'<a class="level-'+c.level+'" href="#'+c.id+'">'+c.title+"</a></li>"}return m(e,t)},m=function(e,t){return'<div class="'+c(e)+'" contenteditable="false">'+t+"</div>"},o=function(d){d.tocUpdater&&clearTimeout(d.tocUpdater),d.tocUpdater=setTimeout(function(){var e=c(d),o=d.$("."+e);if(o.length<=0)return"";for(var r=i(d),u=s(d),t=0;t<o.length;t++)!function(e){var t,c,i,a,l,n=o[e];t=n.innerHTML,c=u,i=0,l=a=!1,t.replace(/<a class="level-(\d)" href="[^"]*?#(.*?)">(.*?)<\/a>/g,function(e,t,n,o){var r=c[i];return r&&t==r.level&&n==r.id&&o==r.title||(a=!0),i++,l=!0,e}),l&&!a&&!c[i]||d.undoManager.ignore(function(){n.outerHTML=r})}(t)},100)},r=function(t){t.addCommand("cherryInsertToc",function(){var e;(e=t).insertContent(i(e)+"<p></p>")}),t.addCommand("cherryUpdateToc",function(){o(t)}),t.addCommand("cherryRemoveToc",function(){!function(e){var t,n=e.selection.getNode(),o=null;if(e.dom.is(n,"div")&&e.dom.hasClass(n,c(e))?o=n:(t=e.dom.getParent(n,"div."+c(e)))&&(o=t),!o||!e.dom.hasClass(o,c(e)))return;e.dom.remove(o),e.nodeChanged()}(t)})},a=function(e){var n,t;e.ui.registry.addButton("ch-toc",{icon:"cherry-toc",tooltip:"Table of contents",onAction:function(){return e.execCommand("cherryInsertToc")},onSetup:(n=e,function(e){var t=function(){e.setDisabled(n.mode.isReadOnly())};return t(),n.on("LoadContent SetContent change",t),n.on("change keyup",function(){n.execCommand("cherryUpdateToc")}),function(){return n.on("LoadContent SetContent change",t)}})}),e.ui.registry.addButton("ch-toc-remove",{icon:"remove",tooltip:"Remove",onAction:function(){return e.execCommand("cherryRemoveToc")}}),e.ui.registry.addContextToolbar("ch-toc",{items:"ch-toc-remove",predicate:(t=e,function(e){return e&&t.dom.is(e,"."+t.getParam("toc_class","toc"))&&t.getBody().contains(e)&&e.getAttribute("data-mce-selected")}),scope:"node",position:"node"})};e.add("cherry-toc",function(e){r(e),a(e)})}();