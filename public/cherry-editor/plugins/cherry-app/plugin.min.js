!function(){"use strict";var t=tinymce.util.Tools.resolve("tinymce.PluginManager"),c=tinymce.util.Tools.resolve("tinymce.util.I18n").translate,e=1,r=(i.prototype.init=function(t){var i=this;this.editor=t,this.editor.settings._cherryAppId=e,e+=1,this.editor.on("OPENAPP_ENTRANCE_INIT:SUCCESS",function(t){var e=i.getAppDialogEl(".j-dialog-loading");e&&(e.style.display="none")}),this.editor.on("OPENAPP_ENTRANCE_CONFIRM:SUCCESS",function(t){i.onSure(t.filename,t.url,t.sub)})},i.prototype.cleanup=function(){var t=this.getAppDialogEl();null!=t&&t.remove()},i.prototype.onSure=function(t,e,i){void 0===i&&(i="");var a=this,n=a.target,r=a.encodeJSON(a.appConfig),o='\n<div class="cherry-app-wrapper" contenteditable="false" style="position: relative;" data-app-filename="CHERRY_APP_FILENAME" data-app-url="CHERRY_APP_FILEURL" data-app-config="CHERRY_APP_CONFIG" data-app-mode="1">\n  <div class="preview-card">\n      <iframe src="CHERRY_APP_FILEURL" frameborder="0"></iframe>\n      <div class="filename" title="CHERRY_APP_FILENAME">\n          <img />\n          <span class="name">CHERRY_APP_NAME</span>\n          <span class="note">CHERRY_APP_NOTE</span>\n      </div>\n  </div>\n  <div class="preview-textlink" style="display: none">\n      <img />\n      <span>CHERRY_APP_FILENAME</span>\n  </div>\n  <span class="end"></span>\n</div>\n'.replace(/CHERRY_APP_FILEURL/g,e).replace(/CHERRY_APP_FILENAME/g,""+t+i).replace(/CHERRY_APP_NAME/g,t).replace(/CHERRY_APP_NOTE/g,i).replace(/CHERRY_APP_CONFIG/g,r);n.outerHTML=o;var p=this.getAppDialogEl();p&&(p.style.display="none"),a.target=null,a.editor.fire("closeCustomDialog")},i.prototype.openAppDialog=function(t){t&&(this.appConfig=this.decodeJSON(t.getAttribute("data-app-config")),this.appConfig.iframeId="cherry-open-app-dialog-iframe",this.setDialogVisible(t,!0,t.getAttribute("data-app-filename"),t.getAttribute("data-app-url")))},i.prototype.setDialogVisible=function(t,e,i,a){var n=this;void 0===i&&(i=""),void 0===a&&(a="");var r,o,p,l=!1;this.target&&(l=!!this.target.getAttribute("data-start-key"),!e&&l&&this.editor.dom.remove(this.target)),this.dialogVisble=e,this.created&&this.resetDialogSize(),e?(this.target=t,r=Object.assign({},this.appConfig),a&&(r.filename=i,r.fileurl=a),this.createIframe(r.url,function(){n.updateApp(r)}),(p=this.getAppDialogEl())&&(p.style.display="block"),(o=this.getAppDialogEl(".j-dialog-loading"))&&(o.style.display="block")):((p=this.getAppDialogEl())&&(p.style.display="none"),l||(this.target.setAttribute("data-app-filename",this.target.getAttribute("data-app-oldfilename")),this.target.setAttribute("data-app-url",this.target.getAttribute("data-app-oldurl")),this.target.setAttribute("data-app-oldfilename",""),this.target.setAttribute("data-app-oldurl","")),this.target=t)},i.prototype.insertEmptyImg=function(t){this.appConfig=t,this.appConfig.iframeId="cherry-open-app-dialog-iframe";var e=this.encodeJSON(this.generateRandomKey()).replace(/=/g,"");this.editor.insertContent(this.createEmptyApphImg(e));var i=this.editor.$('img[data-start-key="'+e+'"]');this.openAppDialog(i[0])},i.prototype.createEmptyApphImg=function(t){return'<img src="'+this.editor.getParam("mindmap_empty_img")+'" style="display:none" data-start-key="'+t+'" alt="cherry-app" data-control="cherry-app" data-app-filename data-app-url data-app-config="'+this.encodeJSON(this.appConfig)+'">'},i.prototype.createIframe=function(t,e){var i=this.getAppDialogEl();if(this.created&&i)return document.querySelector("#cherry-open-app-dialog-iframe").setAttribute("src",t),(i.querySelector(".cherry-app-dialog__head-title")||{}).innerText=this.appConfig.name,void e();this.created=!0;var a=document.createElement("div"),n=this.editor.settings._cherryAppId;a.setAttribute("class","cherry-app-dialog j-cherry-app-dialog j-cherry-app-dialog-"+n+" cherry-app-dialog--normal"),a.style="display:none;";var r="",o=this.appConfig,p=o.width,l=o.height,s=o.name;p&&(r+="width: "+p+"px;"),l&&(r+="height: "+l+"px;"),a.innerHTML='\n    <div class="cherry-app-dialog__mask">\n    <div class="cherry-app-dialog__content" style="CHERRY_APP_STYLE">\n        <div class="cherry-app-dialog__head clearfix">\n            <span class="cherry-app-dialog__head-title">INSERT_APP_NAME</span>\n            <span class="cherry-app-dialog__head-close ico-dialog-close j-close-dialog"></span>\n            <span class="cherry-app-dialog__head-fullscreen font-editor font-editor-fullscreen j-set-dialog-size" style="display: none"></span>\n        </div>\n        <div class="cherry-app-dialog__body">\n            <div class="cherry-app-dialog__body--loading j-dialog-loading" style="display: block;">\n               <div class="cherry-app-dialog__body--loading_icon strip-loading2"></div>\n            </div>\n            <iframe style="visibility: visible;" allowtransparency="true" id="cherry-open-app-dialog-iframe" src="CHERRY_APP_URL" width="100%" frameborder="0" height="100%" loaded="true"></iframe>\n        </div>\n        <div class="cherry-app-dialog__foot">\n        <div class="cherry-app-dialog__foot-btns">\n            <span class="foot-btn foot-btn__ensure j-foot-btn__ensure">COMFIRM</span>\n            <span class="foot-btn foot-btn__cancel j-close-dialog">CANCEL</span>\n        </div>\n        </div>\n    </div>\n    </div>\n'.replace("CHERRY_APP_URL",t).replace("CHERRY_APP_STYLE",r).replace("INSERT_APP_NAME",""+c("Insert ")+c(s)).replace("COMFIRM",c("Comfirm")).replace("CANCEL",c("Cancel")),document.body.appendChild(a),this.bindEvent(),e()},i.prototype.updateApp=function(t){this.dialogVisble&&(this.editor.fire("OPENAPP_ENTRANCE_INIT",t),this.target.getAttribute("data-app-oldurl")||(this.target.setAttribute("data-app-oldfilename",this.target.getAttribute("data-app-filename")),this.target.setAttribute("data-app-oldurl",this.target.getAttribute("data-app-url"))))},i.prototype.decodeJSON=function(t){return t?JSON.parse(decodeURIComponent(escape(window.atob(t)))):null},i.prototype.encodeJSON=function(t){return window.btoa(unescape(encodeURIComponent(JSON.stringify(t))))},i.prototype.bindEvent=function(){var t,e,r=this,i=this.getAppDialogEl();i&&((t=this.getAppDialogEl(".j-foot-btn__ensure"))&&t.addEventListener("click",function(t){r.onInsertApp(t),r.editor.fire("showDialogTitle")}),i.querySelectorAll(".j-close-dialog").forEach(function(t){t.addEventListener("click",function(t){r.editor.fire("showDialogTitle"),r.setDialogVisible(null,!1),r.editor.fire("closeCustomDialog")})}),(e=this.getAppDialogEl(".j-set-dialog-size"))&&e.addEventListener("click",function(t){var e=r.getAppDialogEl(),i=t.target,a="",n=(n=i.getAttribute("class")).indexOf("font-editor-fullscreen-restore")<0?(a=e.getAttribute("class").replace(/cherry-app-dialog--normal/g,"cherry-app-dialog--fullscreen"),n.replace(/font-editor-fullscreen/g,"font-editor-fullscreen-restore")):(a=e.getAttribute("class").replace(/cherry-app-dialog--fullscreen/g,"cherry-app-dialog--normal"),n.replace(/font-editor-fullscreen-restore/g,"font-editor-fullscreen"));e.setAttribute("class",a),i.setAttribute("class",n)}))},i.prototype.resetDialogSize=function(){var t,e,i,a=this.getAppDialogEl();!a||-1<(t=a.getAttribute("class")).indexOf("cherry-app-dialog--fullscreen")&&(t=t.replace(/cherry-app-dialog--fullscreen/g,"cherry-app-dialog--normal"),a.setAttribute("class",t),(e=this.getAppDialogEl(".j-set-dialog-size"))&&(i=(i=e.getAttribute("class")).replace(/font-editor-fullscreen-restore/g,"font-editor-fullscreen"),e.setAttribute("class",i)))},i.prototype.onInsertApp=function(t){this.editor.fire("OPENAPP_ENTRANCE_CONFIRM")},i.prototype.base64ToFile=function(t,e){for(var i=window.atob(t.split(",")[1]),a=new ArrayBuffer(i.length),n=new Uint8Array(a),r=0;r<i.length;r++)n[r]=i.charCodeAt(r);var o=new Blob([a],{type:"image/png"});return o.lastModifiedDate=new Date,o.name=e,o},i.prototype.beforeInsertJSON=function(i,a){var t=this.editor.getParam("app_before_insert_json","");t?t(i,function(t,e){t?a("id:"+t,e):a(i)}):a(i)},i.prototype.beforeParseJSON=function(e,t,i){var a,n="";e&&0===e.trim().indexOf("id:")?(n=e.trim().replace("id:",""),(a=this.editor.getParam("app_before_parse_json",""))?a(n,t,function(t){i(t||e)}):i(e)):i(e)},i.prototype.generateRandomKey=function(){return Math.random().toString(36)},i.prototype.cacheApp=function(t){this.target.setAttribute("data-app-json",this.encodeJSON(t)),this.editor.fire("keyup",this.editor)},i.prototype.getAppDialogEl=function(t){void 0===t&&(t="");var e=this.editor.settings._cherryAppId,i=document.querySelector(".j-cherry-app-dialog-"+e);return t?null==i?void 0:i.querySelector(t):i},i);function i(){this.target=null,this.editor=null,this.created=!1,this.dialogVisble=!1,this.handlers={},this.appConfig={}}t.add("cherry-app",function(i){var a=new r;a.init(i),i.on("remove",function(){a.cleanup()}),i.ui.registry.addIcon("ch-app",'<svg width="20" height="20" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\t viewBox="0 0 24 24" style="enable-background:new 0 0 24 24;" xml:space="preserve"><style type="text/css">\t.st0{fill-rule:evenodd;clip-rule:evenodd;fill:url(#\u77e9\u5f62_1_);}\t.st1{opacity:0.3;fill-rule:evenodd;clip-rule:evenodd;fill:#FFFFFF;enable-background:new    ;}\t.st2{opacity:0.6;fill-rule:evenodd;clip-rule:evenodd;fill:#FFFFFF;enable-background:new    ;}\t.st3{fill-rule:evenodd;clip-rule:evenodd;fill:#FFFFFF;}</style><linearGradient id="\u77e9\u5f62_1_" gradientUnits="userSpaceOnUse" x1="-272.8743" y1="415.7895" x2="-272.3338" y2="414.8329" gradientTransform="matrix(24 0 0 -24 6555 9980.3604)">\t<stop  offset="0" style="stop-color:#6DA6FF"/>\t<stop  offset="1" style="stop-color:#2F7AFD"/></linearGradient><path id="\u77e9\u5f62" class="st0" d="M3,0h18c1.7,0,3,1.3,3,3v18c0,1.7-1.3,3-3,3H3c-1.7,0-3-1.3-3-3V3C0,1.3,1.3,0,3,0z"/><g id="Group-3" transform="translate(4.000000, 3.600000)">\t<path id="Rectangle-19" class="st1" d="M8.7,8.5l7.6,3.5c0.4,0.2,0.5,0.6,0.3,0.9c-0.1,0.1-0.2,0.3-0.3,0.3l-7.6,4\t\tc-0.2,0.1-0.4,0.1-0.6,0l-7.6-4c-0.3-0.2-0.5-0.6-0.3-0.9c0.1-0.1,0.2-0.2,0.3-0.3l7.6-3.5C8.3,8.4,8.5,8.4,8.7,8.5z"/>\t<path id="Rectangle-19_1_" class="st2" d="M8.7,4.5L16.3,8c0.4,0.2,0.5,0.6,0.3,0.9c-0.1,0.1-0.2,0.3-0.3,0.3l-7.6,4\t\tc-0.2,0.1-0.4,0.1-0.6,0l-7.6-4C0.1,9.1,0,8.7,0.1,8.3C0.2,8.2,0.3,8.1,0.5,8l7.6-3.5C8.3,4.4,8.5,4.4,8.7,4.5z"/>\t<path id="Rectangle-19_2_" class="st3" d="M8.2,0.4L15.7,4C16,4.2,16.2,4.6,16,5c-0.1,0.1-0.2,0.2-0.3,0.3L8.2,9.4\t\tC8,9.5,7.8,9.5,7.6,9.4L0.1,5.3c-0.3-0.2-0.5-0.6-0.3-1C-0.1,4.2,0,4.1,0.1,4l7.5-3.6C7.8,0.3,8,0.3,8.2,0.4z"/></g></svg>'),i.ui.registry.addIcon("ch-app-textlink",'<svg width="12" height="12" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\n\t viewBox="0 0 850.394 850.394" enable-background="new 0 0 850.394 850.394" xml:space="preserve">\n<g>\n\t<path fill="#040000" d="M214.426,580.873C129.275,580.873,60,511.599,60,426.448s69.275-154.425,154.425-154.425h114.089\n\t\tc85.15,0,154.424,69.275,154.424,154.425c0,16.568,13.432,30,30,30s30-13.432,30-30c0-118.234-96.19-214.425-214.424-214.425\n\t\tH214.426c-57.275,0-111.122,22.304-151.622,62.804C22.305,315.327,0,369.173,0,426.448c0,57.275,22.304,111.122,62.804,151.621\n\t\tc40.5,40.5,94.347,62.804,151.622,62.804c16.568,0,30-13.432,30-30S230.994,580.873,214.426,580.873z"/>\n\t<path fill="#040000" d="M787.59,272.324c-40.5-40.499-94.347-62.803-151.622-62.803c-16.568,0-30,13.432-30,30s13.432,30,30,30\n\t\tc85.15,0,154.426,69.274,154.426,154.424c0,85.151-69.275,154.426-154.426,154.426H521.879\n\t\tc-85.149,0-154.424-69.275-154.424-154.426c0-16.568-13.432-30-30-30s-30,13.432-30,30c0,57.275,22.304,111.122,62.803,151.622\n\t\tc40.5,40.5,94.347,62.805,151.621,62.805h114.089c57.275,0,111.122-22.305,151.622-62.805s62.804-94.347,62.804-151.622\n\t\tS828.089,312.823,787.59,272.324z"/>\n</g>\n</svg>'),i.ui.registry.addIcon("ch-app-card",'<svg width="12" height="12" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\nviewBox="0 0 850.394 850.394" enable-background="new 0 0 850.394 850.394" xml:space="preserve">\n<g>\n<path fill="#040000" d="M793.139,0H57.256C25.685,0,0,25.686,0,57.257v586.72c0,31.57,25.685,57.255,57.255,57.255h735.883\n   c31.57,0,57.255-25.685,57.255-57.255V57.257C850.394,25.686,824.709,0,793.139,0z M790.394,641.231H60V60h730.393V641.231z"/>\n<path fill="#040000" d="M820.394,790.394H30c-16.568,0-30,13.432-30,30s13.432,30,30,30h790.393c16.568,0,30-13.432,30-30\n   S836.962,790.394,820.394,790.394z"/>\n</g>\n</svg>'),i.ui.registry.addIcon("ch-app-open",'<svg width="12" height="12" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\nviewBox="0 0 850.394 850.394" enable-background="new 0 0 850.394 850.394" xml:space="preserve">\n<g>\n<path fill="#060001" d="M816.97,259.72c-21.41-50.64-52.06-96.11-91.09-135.15c-39.04-39.05-84.5-69.71-135.13-91.13\n   C538.31,11.25,482.63,0,425.25,0c-57.39,0-113.09,11.25-165.54,33.44c-50.64,21.42-96.11,52.08-135.16,91.13\n   c-39.04,39.04-69.7,84.51-91.12,135.14C11.25,312.15,0,367.83,0,425.2c0,57.39,11.25,113.08,33.43,165.52\n   c21.42,50.64,52.08,96.11,91.13,135.15c39.04,39.03,84.52,69.69,135.16,91.1c52.44,22.18,108.13,33.42,165.53,33.42\n   c57.38,0,113.06-11.24,165.49-33.42c50.64-21.42,96.1-52.07,135.13-91.11c39.04-39.03,69.69-84.5,91.1-135.14\n   c22.18-52.44,33.42-108.13,33.42-165.52C850.39,367.83,839.15,312.15,816.97,259.72z M683.45,683.44\n   c-68.97,68.97-160.66,106.95-258.2,106.95c-97.56,0-189.29-37.98-258.27-106.95C97.99,614.46,60,522.75,60,425.2\n   c0-97.52,37.99-189.22,106.98-258.21C235.98,98,327.7,60,425.25,60c97.52,0,189.22,38,258.19,106.99S790.39,327.68,790.39,425.2\n   C790.39,522.75,752.41,614.47,683.45,683.44z"/>\n<path fill="#060001" d="M593.87,219.14L348.08,319.53c-7.16,2.92-12.91,8.5-16.06,15.56L217.78,591.27\n   c-4.95,11.1-2.71,24.09,5.66,32.9c5.78,6.06,13.68,9.32,21.74,9.32c3.64,0,7.32-0.67,10.84-2.03l259.65-100.67\n   c7.82-3.03,14.01-9.2,17.08-17.02l100.39-255.9c4.39-11.18,1.69-23.89-6.86-32.32C617.73,217.12,604.98,214.6,593.87,219.14z\n    M425.2,485.4c-33.25,0-60.21-26.95-60.21-60.2s26.96-60.21,60.21-60.21s60.2,26.96,60.2,60.21S458.45,485.4,425.2,485.4z"/>\n</g>\n</svg>'),i.ui.registry.addIcon("ch-app-remove",'<svg width="12" height="12" version="1.1" id="\u56fe\u5c42_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"\nviewBox="0 0 850.394 850.394" enable-background="new 0 0 850.394 850.394" xml:space="preserve">\n<g>\n<path fill="#040000" d="M814.887,72.207H700.737H561.039V44.433c0-2.701-0.255-5.341-0.719-7.911\n   c0.466-2.101,0.719-4.281,0.719-6.522c0-16.568-13.432-30-30-30h-14.433H333.789h-14.434c-16.568,0-30,13.432-30,30\n   c0,2.241,0.253,4.421,0.719,6.522c-0.464,2.569-0.719,5.21-0.719,7.911v27.774H149.659H35.507c-16.568,0-30,13.432-30,30\n   s13.432,30,30,30h71.032v672.142c0,25.39,19.343,46.045,43.12,46.045h551.079c23.776,0,43.119-20.655,43.119-46.045V132.207h71.03\n   c16.568,0,30-13.432,30-30S831.455,72.207,814.887,72.207z M349.355,60h151.684v12.207H349.355V60z M683.856,790.394H166.539\n   V132.207h167.25h182.817h167.25V790.394z"/>\n<path fill="#040000" d="M328.978,286.972c-16.568,0-30,13.432-30,30V605.63c0,16.568,13.432,30,30,30s30-13.432,30-30V316.972\n   C358.978,300.403,345.546,286.972,328.978,286.972z"/>\n<path fill="#040000" d="M491.417,316.972V605.63c0,16.568,13.432,30,30,30s30-13.432,30-30V316.972c0-16.568-13.432-30-30-30\n   S491.417,300.403,491.417,316.972z"/>\n</g>\n</svg>'),i.on("openCustomDialog",function(){i.getBody().setAttribute("contenteditable","false")}),i.on("closeCustomDialog",function(){i.getBody().setAttribute("contenteditable","true")});for(var t=0;t<10;t++)!function(e){i.ui.registry.addButton("ch-app"+e,{icon:"ch-app",tooltip:"CherryApp"+e,onAction:function(){var t=i.getParam("getCherryAppConfig",null);t&&t(function(t){t.length>e&&(a.insertEmptyImg(t[e]),i.fire("openCustomDialog"))})}})}(t);var n=null;i.ui.registry.addToggleButton("ch-app-textlink",{tooltip:"Text Link",icon:"ch-app-textlink",onAction:function(t){var e;n&&((e=i.$(n)).attr("data-app-mode","2"),e.css({width:"max-content","box-shadow":"none"}),e.find(".preview-card").css("display","none"),e.find(".preview-textlink").css("display","inline-flex"),document.querySelector(".tox-pop").remove(),t.setActive(!t.isActive()))},onSetup:function(t){var e;return n&&(e=i.$(n),t.setActive("2"===e.attr("data-app-mode"))),function(){}}}),i.ui.registry.addToggleButton("ch-app-card",{tooltip:"Card Preview",icon:"ch-app-card",onAction:function(t){var e;n&&((e=i.$(n)).css({width:"50%","box-shadow":"5px 5px 5px #e0e0e0"}),e.attr("data-app-mode","1"),e.find(".preview-textlink").css("display","none"),e.find(".preview-card").css("display","block"),document.querySelector(".tox-pop").remove(),t.setActive(!t.isActive()))},onSetup:function(t){var e;return n&&(e=i.$(n),t.setActive("1"===e.attr("data-app-mode"))),function(){}}}),i.ui.registry.addButton("ch-app-open",{tooltip:"Open",icon:"ch-app-open",onAction:function(){n&&window.open(n.getAttribute("data-app-url"))}}),i.ui.registry.addButton("ch-app-remove",{tooltip:"Delete",icon:"ch-app-remove",onAction:function(){n&&(n.outerHTML="<br />",document.querySelector(".tox-pop").remove())}}),i.ui.registry.addContextToolbar("ch-app-toolbar",{items:"ch-app-textlink ch-app-card ch-app-open ch-app-edit ch-app-remove",predicate:function(t){return"cherry-app-wrapper"===t.className?((n=t).setAttribute("data-mce-selected","1"),!0):(n&&(n.removeAttribute("data-mce-selected"),n=null),!1)},position:"node",scope:"node"})})}();